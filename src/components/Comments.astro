---
interface Props {
  postSlug: string;
}

const { postSlug } = Astro.props;
---

<div class="comments-section" data-post-slug={postSlug}>
  <h3 class="text-xl font-semibold text-text-heading mb-6">Comments</h3>

  <!-- Comment form (shown when logged in) -->
  <div id="comment-form-container" class="mb-8">
    <div id="login-prompt" class="p-6 rounded-lg bg-bg-secondary border border-border-subtle text-center">
      <p class="text-text-secondary mb-4">Sign in to leave a comment</p>
      <button
        id="login-btn"
        class="btn btn-primary"
      >
        Sign in with Google
      </button>
    </div>

    <form id="comment-form" class="hidden">
      <div class="flex items-start gap-4">
        <div id="user-avatar" class="w-10 h-10 rounded-full bg-bg-tertiary flex-shrink-0"></div>
        <div class="flex-1">
          <textarea
            id="comment-input"
            class="input w-full min-h-[100px] resize-y"
            placeholder="Write a comment... (Markdown supported)"
            required
          ></textarea>
          <div class="flex items-center justify-between mt-3">
            <span class="text-xs text-text-secondary">Markdown supported</span>
            <button type="submit" class="btn btn-primary">
              Post Comment
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Comments list -->
  <div id="comments-list" class="space-y-6">
    <div class="text-center py-8 text-text-secondary">
      Loading comments...
    </div>
  </div>
</div>

<script>
  const container = document.querySelector('.comments-section');
  const postSlug = container?.getAttribute('data-post-slug');
  const loginPrompt = document.getElementById('login-prompt');
  const loginBtn = document.getElementById('login-btn');
  const commentForm = document.getElementById('comment-form') as HTMLFormElement;
  const commentInput = document.getElementById('comment-input') as HTMLTextAreaElement;
  const commentsList = document.getElementById('comments-list');
  const userAvatar = document.getElementById('user-avatar');

  let currentUser: any = null;
  let replyingTo: string | null = null;

  // Check authentication
  async function checkAuth() {
    try {
      const response = await fetch('/api/auth/session');
      if (response.ok) {
        const data = await response.json();
        if (data.user) {
          currentUser = data.user;
          showCommentForm();
          return;
        }
      }
    } catch (error) {
      console.error('Auth check failed:', error);
    }
    showLoginPrompt();
  }

  function showLoginPrompt() {
    loginPrompt?.classList.remove('hidden');
    commentForm?.classList.add('hidden');
  }

  function showCommentForm() {
    loginPrompt?.classList.add('hidden');
    commentForm?.classList.remove('hidden');
    if (userAvatar && currentUser?.image) {
      userAvatar.innerHTML = `<img src="${currentUser.image}" alt="${currentUser.name}" class="w-full h-full rounded-full object-cover" />`;
    }
  }

  // Load comments
  async function loadComments() {
    try {
      const response = await fetch(`/api/comments?slug=${encodeURIComponent(postSlug || '')}`);
      if (response.ok) {
        const comments = await response.json();
        renderComments(comments);
      }
    } catch (error) {
      console.error('Failed to load comments:', error);
      if (commentsList) {
        commentsList.innerHTML = '<div class="text-center py-8 text-text-secondary">Failed to load comments</div>';
      }
    }
  }

  // Render comments
  function renderComments(comments: any[], parentId: string | null = null, depth = 0) {
    const filtered = comments.filter(c => c.parentId === parentId);

    if (filtered.length === 0 && !parentId) {
      if (commentsList) {
        commentsList.innerHTML = '<div class="text-center py-8 text-text-secondary">No comments yet. Be the first to comment!</div>';
      }
      return;
    }

    if (!parentId && commentsList) {
      commentsList.innerHTML = '';
    }

    filtered.forEach(comment => {
      const el = createCommentElement(comment, depth);
      if (parentId) {
        const parent = commentsList?.querySelector(`[data-comment-id="${parentId}"]`);
        const repliesContainer = parent?.querySelector('.replies');
        repliesContainer?.appendChild(el);
      } else {
        commentsList?.appendChild(el);
      }

      // Render nested replies
      renderComments(comments, comment.id, depth + 1);
    });
  }

  // Create comment element
  function createCommentElement(comment: any, depth: number) {
    const div = document.createElement('div');
    div.className = `comment ${depth > 0 ? 'ml-8 mt-4' : ''}`;
    div.setAttribute('data-comment-id', comment.id);

    const timeAgo = formatTimeAgo(new Date(comment.createdAt));
    const isOwner = currentUser?.id === comment.userId;

    div.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="w-8 h-8 rounded-full bg-bg-tertiary flex-shrink-0 overflow-hidden">
          ${comment.user?.image ? `<img src="${comment.user.image}" alt="${comment.user.name}" class="w-full h-full object-cover" />` : ''}
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-medium text-text-primary">${comment.user?.name || 'Anonymous'}</span>
            <span class="text-xs text-text-secondary">${timeAgo}</span>
            ${comment.updatedAt !== comment.createdAt ? '<span class="text-xs text-text-secondary">(edited)</span>' : ''}
          </div>
          <div class="prose prose-sm max-w-none text-text-primary comment-content">
            ${comment.content}
          </div>
          <div class="flex items-center gap-4 mt-2">
            ${currentUser ? `<button class="reply-btn text-sm text-text-secondary hover:text-accent">Reply</button>` : ''}
            ${isOwner ? `
              <button class="edit-btn text-sm text-text-secondary hover:text-accent">Edit</button>
              <button class="delete-btn text-sm text-text-secondary hover:text-error">Delete</button>
            ` : ''}
          </div>
          <div class="reply-form hidden mt-4"></div>
          <div class="replies"></div>
        </div>
      </div>
    `;

    // Event listeners
    const replyBtn = div.querySelector('.reply-btn');
    const editBtn = div.querySelector('.edit-btn');
    const deleteBtn = div.querySelector('.delete-btn');
    const replyForm = div.querySelector('.reply-form');

    replyBtn?.addEventListener('click', () => {
      if (replyForm) {
        replyForm.classList.toggle('hidden');
        if (!replyForm.classList.contains('hidden')) {
          replyForm.innerHTML = `
            <textarea class="input w-full min-h-[80px] resize-y mb-2" placeholder="Write a reply..."></textarea>
            <div class="flex justify-end gap-2">
              <button type="button" class="cancel-reply btn btn-secondary text-sm">Cancel</button>
              <button type="button" class="submit-reply btn btn-primary text-sm">Reply</button>
            </div>
          `;

          replyForm.querySelector('.cancel-reply')?.addEventListener('click', () => {
            replyForm.classList.add('hidden');
          });

          replyForm.querySelector('.submit-reply')?.addEventListener('click', async () => {
            const textarea = replyForm.querySelector('textarea') as HTMLTextAreaElement;
            if (textarea.value.trim()) {
              await submitComment(textarea.value, comment.id);
              replyForm.classList.add('hidden');
            }
          });
        }
      }
    });

    editBtn?.addEventListener('click', async () => {
      const contentEl = div.querySelector('.comment-content');
      if (contentEl) {
        const currentContent = comment.content;
        contentEl.innerHTML = `
          <textarea class="input w-full min-h-[80px] resize-y">${currentContent}</textarea>
          <div class="flex justify-end gap-2 mt-2">
            <button type="button" class="cancel-edit btn btn-secondary text-sm">Cancel</button>
            <button type="button" class="save-edit btn btn-primary text-sm">Save</button>
          </div>
        `;

        contentEl.querySelector('.cancel-edit')?.addEventListener('click', () => {
          contentEl.innerHTML = currentContent;
        });

        contentEl.querySelector('.save-edit')?.addEventListener('click', async () => {
          const textarea = contentEl.querySelector('textarea') as HTMLTextAreaElement;
          if (textarea.value.trim()) {
            await updateComment(comment.id, textarea.value);
          }
        });
      }
    });

    deleteBtn?.addEventListener('click', async () => {
      if (confirm('Are you sure you want to delete this comment?')) {
        await deleteComment(comment.id);
      }
    });

    return div;
  }

  // Submit comment
  async function submitComment(content: string, parentId: string | null = null) {
    try {
      const response = await fetch('/api/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: postSlug, content, parentId }),
      });

      if (response.ok) {
        loadComments();
        if (commentInput) commentInput.value = '';
      }
    } catch (error) {
      console.error('Failed to submit comment:', error);
    }
  }

  // Update comment
  async function updateComment(id: string, content: string) {
    try {
      const response = await fetch(`/api/comments/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content }),
      });

      if (response.ok) {
        loadComments();
      }
    } catch (error) {
      console.error('Failed to update comment:', error);
    }
  }

  // Delete comment
  async function deleteComment(id: string) {
    try {
      const response = await fetch(`/api/comments/${id}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        loadComments();
      }
    } catch (error) {
      console.error('Failed to delete comment:', error);
    }
  }

  // Format time ago
  function formatTimeAgo(date: Date) {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const mins = Math.floor(diff / 60000);
    const hours = Math.floor(mins / 60);
    const days = Math.floor(hours / 24);

    if (mins < 1) return 'just now';
    if (mins < 60) return `${mins}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
  }

  // Login handler
  loginBtn?.addEventListener('click', () => {
    window.location.href = '/api/auth/signin/google';
  });

  // Comment form submission
  commentForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (commentInput.value.trim()) {
      await submitComment(commentInput.value);
    }
  });

  // Initialize
  checkAuth();
  loadComments();
</script>
