---
interface Props {
  postSlug: string;
}

const { postSlug } = Astro.props;
---

<div class="comments-section" data-post-slug={postSlug}>
  <h3 class="text-xl font-semibold text-text-heading mb-6">Comments</h3>

  <!-- Comment form -->
  <form id="comment-form" class="mb-8">
    <div class="flex items-start gap-4">
      <div class="w-10 h-10 rounded-full bg-bg-tertiary flex-shrink-0 flex items-center justify-center text-text-secondary">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      </div>
      <div class="flex-1">
        <input
          type="text"
          id="author-name"
          class="input w-full mb-3"
          placeholder="Your name"
          maxlength="50"
          required
        />
        <textarea
          id="comment-input"
          class="input w-full min-h-[100px] resize-y"
          placeholder="Write a comment..."
          maxlength="5000"
          required
        ></textarea>
        <div class="flex items-center justify-end mt-3">
          <button type="submit" class="btn btn-primary">
            Post Comment
          </button>
        </div>
      </div>
    </div>
  </form>

  <!-- Comments list -->
  <div id="comments-list" class="space-y-6">
    <div class="text-center py-8 text-text-secondary">
      Loading comments...
    </div>
  </div>
</div>

<script>
  const container = document.querySelector('.comments-section');
  const postSlug = container?.getAttribute('data-post-slug');
  const commentForm = document.getElementById('comment-form') as HTMLFormElement;
  const authorInput = document.getElementById('author-name') as HTMLInputElement;
  const commentInput = document.getElementById('comment-input') as HTMLTextAreaElement;
  const commentsList = document.getElementById('comments-list');

  // Get/set author name from localStorage
  function getSavedAuthorName(): string {
    return localStorage.getItem('comment_author_name') || '';
  }

  function saveAuthorName(name: string): void {
    localStorage.setItem('comment_author_name', name);
  }

  // Initialize author name from localStorage
  if (authorInput) {
    authorInput.value = getSavedAuthorName();
  }

  // Load comments
  async function loadComments() {
    try {
      const response = await fetch(`/api/comments?slug=${encodeURIComponent(postSlug || '')}`);
      if (response.ok) {
        const comments = await response.json();
        renderComments(comments);
      }
    } catch (error) {
      console.error('Failed to load comments:', error);
      if (commentsList) {
        commentsList.innerHTML = '<div class="text-center py-8 text-text-secondary">Failed to load comments</div>';
      }
    }
  }

  // Render comments
  function renderComments(comments: any[], parentId: string | null = null, depth = 0) {
    const filtered = comments.filter(c => c.parentId === parentId);

    if (filtered.length === 0 && !parentId) {
      if (commentsList) {
        commentsList.innerHTML = '<div class="text-center py-8 text-text-secondary">No comments yet. Be the first to comment!</div>';
      }
      return;
    }

    if (!parentId && commentsList) {
      commentsList.innerHTML = '';
    }

    filtered.forEach(comment => {
      const el = createCommentElement(comment, depth);
      if (parentId) {
        const parent = commentsList?.querySelector(`[data-comment-id="${parentId}"]`);
        const repliesContainer = parent?.querySelector('.replies');
        repliesContainer?.appendChild(el);
      } else {
        commentsList?.appendChild(el);
      }

      // Render nested replies
      renderComments(comments, comment.id, depth + 1);
    });
  }

  // Create comment element
  function createCommentElement(comment: any, depth: number) {
    const div = document.createElement('div');
    div.className = `comment ${depth > 0 ? 'ml-8 mt-4' : ''}`;
    div.setAttribute('data-comment-id', comment.id);

    const timeAgo = formatTimeAgo(new Date(comment.createdAt));
    const initial = (comment.authorName || 'A').charAt(0).toUpperCase();

    div.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="w-8 h-8 rounded-full bg-accent/20 flex-shrink-0 flex items-center justify-center text-sm font-medium text-accent">
          ${initial}
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <span class="font-medium text-text-primary">${escapeHtml(comment.authorName || 'Anonymous')}</span>
            <span class="text-xs text-text-secondary">${timeAgo}</span>
            ${comment.updatedAt !== comment.createdAt ? '<span class="text-xs text-text-secondary">(edited)</span>' : ''}
          </div>
          <div class="prose prose-sm max-w-none text-text-primary comment-content whitespace-pre-wrap">
            ${escapeHtml(comment.content)}
          </div>
          <div class="flex items-center gap-4 mt-2">
            <button class="reply-btn text-sm text-text-secondary hover:text-accent">Reply</button>
          </div>
          <div class="reply-form hidden mt-4"></div>
          <div class="replies"></div>
        </div>
      </div>
    `;

    // Reply button handler
    const replyBtn = div.querySelector('.reply-btn');
    const replyForm = div.querySelector('.reply-form');

    replyBtn?.addEventListener('click', () => {
      if (replyForm) {
        replyForm.classList.toggle('hidden');
        if (!replyForm.classList.contains('hidden')) {
          const savedName = getSavedAuthorName();
          replyForm.innerHTML = `
            <input type="text" class="reply-author input w-full mb-2" placeholder="Your name" value="${escapeHtml(savedName)}" maxlength="50" />
            <textarea class="reply-content input w-full min-h-[80px] resize-y mb-2" placeholder="Write a reply..." maxlength="5000"></textarea>
            <div class="flex justify-end gap-2">
              <button type="button" class="cancel-reply btn btn-secondary text-sm">Cancel</button>
              <button type="button" class="submit-reply btn btn-primary text-sm">Reply</button>
            </div>
          `;

          replyForm.querySelector('.cancel-reply')?.addEventListener('click', () => {
            replyForm.classList.add('hidden');
          });

          replyForm.querySelector('.submit-reply')?.addEventListener('click', async () => {
            const authorEl = replyForm.querySelector('.reply-author') as HTMLInputElement;
            const contentEl = replyForm.querySelector('.reply-content') as HTMLTextAreaElement;
            if (authorEl.value.trim() && contentEl.value.trim()) {
              await submitComment(authorEl.value.trim(), contentEl.value.trim(), comment.id);
              replyForm.classList.add('hidden');
            }
          });
        }
      }
    });

    return div;
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Submit comment
  async function submitComment(authorName: string, content: string, parentId: string | null = null) {
    try {
      saveAuthorName(authorName);

      const response = await fetch('/api/comments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: postSlug, authorName, content, parentId }),
      });

      if (response.ok) {
        loadComments();
        if (commentInput) commentInput.value = '';
      }
    } catch (error) {
      console.error('Failed to submit comment:', error);
    }
  }

  // Format time ago
  function formatTimeAgo(date: Date) {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const mins = Math.floor(diff / 60000);
    const hours = Math.floor(mins / 60);
    const days = Math.floor(hours / 24);

    if (mins < 1) return 'just now';
    if (mins < 60) return `${mins}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
  }

  // Comment form submission
  commentForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (authorInput.value.trim() && commentInput.value.trim()) {
      await submitComment(authorInput.value.trim(), commentInput.value.trim());
    }
  });

  // Initialize
  loadComments();
</script>
